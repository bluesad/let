'''Created on 2012-3-16@author: zongzong'''from mongokit import *import datetimeimport hashlib, hmac, base64, refrom db.mongo import Mongofrom tornado import options  import uuid  @Mongo.db.connection.registerclass Product(Document):      structure = {                 '_id':unicode,                 'cname':basestring,                 'yname':basestring,                 'status':int,                 'address':basestring,                 'phonenum':basestring,                 'begin_ip':basestring,                 'suspended_ip':basestring,                 'continue_to':int,                 'ctype':int,                 'price':int,                 'begin_at':datetime.datetime,                 'created_at':datetime.datetime,                 'suspended_at':datetime.datetime                 }    use_dot_notation = True    @staticmethod    def lookup(c_id):        return Mongo.db.ui.products.find_one({'_id' : uuid.UUID(c_id)})        @staticmethod    def getProduct(cname):        return [u for u in Mongo.db.ui.products.find({'cname' : cname})]        @staticmethod    def getProducts(name, status, yname):        c = Product()        if status:            c.status = status          if name:            c._id = name        if yname:            c.yname = yname        products = [w for w in Mongo.db.ui['products'].find({'cname':{'$regex':c._id}, 'status':int(c.status), 'yname':yname})]                                                                      return products        @staticmethod    def getAllProducts(yname):          products = [c for c in Mongo.db.ui['products'].find({'yname':yname})]        return products        @staticmethod    def insert(yname, status, cname, begin_at, suspended_at, continue_to, ctype, address, phonenum, price,begin_ip,suspended_ip):        c = Product.instance(yname, status, cname, begin_at, suspended_at, continue_to, ctype, address, phonenum, price,begin_ip,suspended_ip)        Mongo.db.ui['products'].insert(c)            @staticmethod    def update(_cid, status, continue_to, begin_at, suspended_at):        c = Product.lookup(_cid)        c.status = status        c.continue_to = continue_to        c.begin_at = begin_at        c.suspended_at = suspended_at          Mongo.db.ui['products'].Product.update(c)            @staticmethod    def delProduct(_cid, status):        Mongo.db.ui['products'].update({"_id":uuid.UUID(_cid)},{'$set':{'status':status}})                 '''    creates a new tool instance. unsaved    '''    @staticmethod    def instance(yname, status, name, begin_at, suspended_at, continue_to, ctype, address, phonenum, price,begin_ip,suspended_ip):        cname = normalize(name)#Operators's name        c = Product()        c['_id'] = uuid.uuid1()        c.cname = cname          c.yname = yname        c.status = status #Operators's name 1 for alive / 0 for died        c.address = address        c.phonenum = phonenum        c.price = price        c.begin_ip = begin_ip        c.suspended_ip = suspended_ip        c.continue_to = continue_to        c.created_at = datetime.datetime.now()        c.begin_at = begin_at        c.suspended_at = suspended_at        c.ctype = ctype        return c     '''normalizes a tool id'''def normalize(name):      if not name :        return None    #allow legal email address    name = name.strip().lower()#    name = re.sub(r'[^a-z0-9\\.\\@_\\-~#]+', '', name)    name = re.sub('\\s+', '_', name)    #don't allow $ and . because they screw up the db.    name = name.replace(".", "")    name = name.replace("$", "")    return name;           